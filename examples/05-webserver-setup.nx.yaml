# Webserver Setup
#
# A practical example: Install and configure nginx with a custom index page.
# Run with:
#   nexus run 05-webserver-setup.nx.yaml -i inventory.yaml --sudo
#
# Or preview changes first with check mode:
#   nexus run 05-webserver-setup.nx.yaml -i inventory.yaml --sudo --check

hosts: webservers

vars:
  webserver_package: nginx
  document_root: /var/www/html
  http_port: 80
  site_title: "My Website"

tasks:
  - name: Install nginx
    package: ${vars.webserver_package}
    state: installed
    sudo: true

  - name: Create document root
    file: ${vars.document_root}
    state: directory
    owner: www-data
    group: www-data
    mode: "0755"
    sudo: true

  - name: Deploy index page
    file: ${vars.document_root}/index.html
    content: |
      <!DOCTYPE html>
      <html>
      <head>
        <title>${vars.site_title}</title>
        <style>
          body { font-family: -apple-system, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
          h1 { color: #333; }
          .info { background: #f5f5f5; padding: 15px; border-radius: 5px; }
        </style>
      </head>
      <body>
        <h1>${vars.site_title}</h1>
        <div class="info">
          <p><strong>Host:</strong> ${host.name}</p>
          <p><strong>Deployed by:</strong> Nexus Infrastructure Automation</p>
        </div>
      </body>
      </html>
    owner: www-data
    group: www-data
    mode: "0644"
    sudo: true
    notify: restart_nginx

  - name: Start nginx
    service: nginx
    state: running
    enabled: true
    sudo: true

handlers:
  - name: restart_nginx
    service: nginx
    state: restarted
    sudo: true
