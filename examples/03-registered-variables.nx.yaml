# Registered Variables
#
# Demonstrates capturing command output and using it in subsequent tasks.
# Run with:
#   nexus run 03-registered-variables.nx.yaml -i inventory.yaml

hosts: all

tasks:
  - name: Get disk usage percentage
    command: df / | awk 'NR==2 {print $5}' | tr -d '%'
    register: disk_pct

  - name: Get memory info
    command: free -m | awk 'NR==2 {printf "%.1f", $3/$2 * 100}'
    register: mem_pct

  - name: Get uptime
    command: uptime -p
    register: uptime_info

  - name: Report system status
    command: |
      echo "=== System Status Report ==="
      echo "Disk usage: ${disk_pct.stdout}%"
      echo "Memory usage: ${mem_pct.stdout}%"
      echo "Uptime: ${uptime_info.stdout}"

  - name: Warn if disk usage is high
    command: echo "WARNING: Disk usage is above 80%!"
    when: ${int(disk_pct.stdout) > 80}
