# Network Discovery

Nexus can automatically discover hosts on your network, eliminating the need for manual inventory management in dynamic environments.

## Quick Start

```bash
# Scan a subnet for SSH hosts
nexus discover --subnet 192.168.1.0/24

# Scan and save to inventory
nexus discover --subnet 192.168.1.0/24 --save-to inventory.yaml

# Run playbook with live discovery
nexus run playbook.yml --discover 192.168.1.0/24
```

## Discovery Command

### Basic Usage

```bash
nexus discover --subnet <CIDR>
```

The discover command scans a network subnet and identifies reachable hosts.

### Command Options

| Option | Description | Default |
|--------|-------------|---------|
| `--subnet <CIDR>` | Subnet to scan in CIDR notation (e.g., 192.168.1.0/24) | Required |
| `--probe <TYPE>` | Probe type: ssh, ping, or tcp:port1,port2 | ssh |
| `--fingerprint` | Enable OS and service fingerprinting | false |
| `--save-to <FILE>` | Save discovered hosts to inventory file | - |
| `--timeout <DURATION>` | Connection timeout per host | 2s |
| `--parallel <N>` | Maximum concurrent probe connections | 100 |
| `--daemon` | Run as continuous monitoring daemon | false |
| `--watch <SUBNETS>` | Comma-separated subnets to watch in daemon mode | - |
| `--interval <DURATION>` | Scan interval for daemon mode | 5m |
| `--notify-on-change <SPEC>` | Notification method when network changes | - |

### Probe Types

**SSH Probe (default)**

Attempts SSH connection to port 22. Most reliable for Linux/Unix hosts.

```bash
nexus discover --subnet 192.168.1.0/24 --probe ssh
```

**Ping Probe**

Uses ICMP echo requests. Fast but may be blocked by firewalls.

```bash
nexus discover --subnet 192.168.1.0/24 --probe ping
```

**TCP Port Probe**

Tests specific TCP ports for connectivity.

```bash
# Single port
nexus discover --subnet 192.168.1.0/24 --probe tcp:80

# Multiple ports
nexus discover --subnet 192.168.1.0/24 --probe tcp:22,80,443
```

## OS Fingerprinting

Enable fingerprinting to detect operating system and service information:

```bash
nexus discover --subnet 192.168.1.0/24 --fingerprint
```

Fingerprinting provides:
- Operating system family (Linux, Windows, macOS, etc.)
- OS version (when detectable)
- Running services and versions
- SSH banner information

**Example output:**

```
Discovered 5 hosts in 192.168.1.0/24:

192.168.1.10 (web-server-01)
  OS: Ubuntu 22.04 LTS
  Services: SSH (OpenSSH 8.9), HTTP (nginx 1.22)

192.168.1.11 (db-server-01)
  OS: Debian 11
  Services: SSH (OpenSSH 8.4), PostgreSQL (15.2)
```

## Saving to Inventory

Save discovered hosts directly to an inventory file:

```bash
nexus discover --subnet 192.168.1.0/24 --save-to inventory.yaml
```

**Generated inventory format:**

```yaml
# Auto-generated by nexus discover
# Discovered: 2025-01-15T10:30:00Z
# Subnet: 192.168.1.0/24

defaults:
  user: admin

all:
  children:
    discovered:
      hosts:
        host-192-168-1-10:
          ansible_host: 192.168.1.10
          discovered_at: "2025-01-15T10:30:00Z"
          discovered_method: ssh
        host-192-168-1-11:
          ansible_host: 192.168.1.11
          discovered_at: "2025-01-15T10:30:00Z"
          discovered_method: ssh
```

**Append to existing inventory:**

```bash
# Will merge discovered hosts with existing groups
nexus discover --subnet 192.168.1.0/24 --save-to existing-inventory.yaml
```

## Performance Tuning

### Timeout Configuration

Adjust timeout for slow or unreliable networks:

```bash
# Fast local network (aggressive)
nexus discover --subnet 10.0.0.0/16 --timeout 500ms --parallel 200

# Slow WAN (conservative)
nexus discover --subnet 10.0.0.0/16 --timeout 10s --parallel 20
```

### Parallel Probes

Control concurrent probe connections:

```bash
# Default (100 concurrent)
nexus discover --subnet 192.168.0.0/16

# Conservative (20 concurrent) - less network load
nexus discover --subnet 192.168.0.0/16 --parallel 20

# Aggressive (500 concurrent) - faster but high load
nexus discover --subnet 192.168.0.0/16 --parallel 500
```

## Discovery Daemon

Run continuous network monitoring to track changes over time.

### Starting the Daemon

```bash
nexus discover --daemon --watch 192.168.1.0/24,10.0.0.0/24 --interval 5m
```

The daemon will:
- Scan watched subnets at regular intervals
- Track new hosts joining the network
- Detect hosts leaving the network
- Monitor service changes

### Daemon Options

```bash
nexus discover --daemon \
  --watch 192.168.1.0/24,10.0.1.0/24 \
  --interval 5m \
  --probe ssh \
  --fingerprint \
  --notify-on-change webhook:https://alerts.example.com/network-change
```

### Change Notifications

Get notified when the network topology changes:

**Webhook Notification**

POST JSON to a webhook URL:

```bash
nexus discover --daemon \
  --watch 192.168.1.0/24 \
  --notify-on-change webhook:https://hooks.example.com/network
```

**Webhook payload:**

```json
{
  "timestamp": "2025-01-15T10:30:00Z",
  "subnet": "192.168.1.0/24",
  "changes": {
    "added": [
      {"address": "192.168.1.50", "hostname": "new-server"}
    ],
    "removed": [
      {"address": "192.168.1.25", "hostname": "old-server"}
    ],
    "modified": [
      {
        "address": "192.168.1.10",
        "changes": ["services_updated"]
      }
    ]
  }
}
```

**File Notification**

Append changes to a log file:

```bash
nexus discover --daemon \
  --watch 192.168.1.0/24 \
  --notify-on-change file:/var/log/nexus-discovery.log
```

**Standard Output**

Print changes to stdout (useful for piping to other tools):

```bash
nexus discover --daemon \
  --watch 192.168.1.0/24 \
  --notify-on-change stdout
```

### Running as a System Service

**Systemd unit file** (`/etc/systemd/system/nexus-discovery.service`):

```ini
[Unit]
Description=Nexus Network Discovery Daemon
After=network.target

[Service]
Type=simple
User=nexus
ExecStart=/usr/local/bin/nexus discover \
  --daemon \
  --watch 192.168.1.0/24 \
  --interval 5m \
  --probe ssh \
  --fingerprint \
  --save-to /var/lib/nexus/discovered-inventory.yaml \
  --notify-on-change file:/var/log/nexus/discovery.log
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

**Enable and start:**

```bash
sudo systemctl enable nexus-discovery
sudo systemctl start nexus-discovery
sudo systemctl status nexus-discovery
```

## Discovery with Playbook Execution

Run playbooks against discovered hosts without creating inventory files:

```bash
# Discover and execute in one command
nexus run playbook.yml --discover 192.168.1.0/24

# With probe options
nexus run playbook.yml --discover 192.168.1.0/24 --probe ssh --timeout 5s
```

This combines discovery and execution:
1. Scans the specified subnet
2. Identifies reachable hosts
3. Executes the playbook against discovered hosts

See [Inventory-less Execution](inventory-less-execution.md) for more details.

## Multiple Subnet Discovery

Scan multiple subnets simultaneously:

```bash
# Comma-separated list
nexus discover --subnet 192.168.1.0/24,10.0.0.0/24,172.16.0.0/20

# With daemon
nexus discover --daemon --watch 192.168.1.0/24,10.0.0.0/24
```

## Security Considerations

### Network Scanning Permissions

- Ensure you have authorization to scan target networks
- Some networks may flag scanning as intrusion attempts
- Use conservative parallel settings in production environments

### SSH Key Authentication

Discovery uses SSH key authentication when available:

```bash
# Specify SSH key for discovery
nexus discover --subnet 192.168.1.0/24 --private-key ~/.ssh/id_ed25519
```

### Firewall Considerations

- ICMP ping may be blocked by firewalls
- TCP port scanning may trigger IDS/IPS alerts
- SSH probe (default) is generally most reliable and least intrusive

## Examples

### Development Environment Discovery

```bash
# Quick local network scan
nexus discover --subnet 192.168.1.0/24 --timeout 1s
```

### Production Network Inventory

```bash
# Comprehensive scan with fingerprinting
nexus discover \
  --subnet 10.0.0.0/16 \
  --probe ssh \
  --fingerprint \
  --timeout 5s \
  --parallel 50 \
  --save-to production-inventory.yaml
```

### Continuous Monitoring

```bash
# Monitor multiple data center subnets
nexus discover --daemon \
  --watch 10.1.0.0/16,10.2.0.0/16,10.3.0.0/16 \
  --interval 10m \
  --probe ssh \
  --fingerprint \
  --save-to /etc/nexus/discovered.yaml \
  --notify-on-change webhook:https://monitoring.example.com/network-changes
```

### Cloud Environment Discovery

```bash
# Scan cloud VPC with aggressive timeout
nexus discover \
  --subnet 172.31.0.0/16 \
  --probe tcp:22,80,443 \
  --timeout 2s \
  --parallel 100 \
  --fingerprint \
  --save-to cloud-inventory.yaml
```

## Troubleshooting

### No Hosts Discovered

- Verify network connectivity: `ping <subnet_ip>`
- Check firewall rules allow SSH/ICMP/TCP
- Try different probe types: `--probe ping` or `--probe tcp:22`
- Increase timeout: `--timeout 10s`
- Verify CIDR notation is correct

### Discovery Too Slow

- Decrease timeout: `--timeout 1s`
- Increase parallelism: `--parallel 200`
- Use ping probe for faster scanning: `--probe ping`
- Reduce subnet size (use /26 or /28 instead of /24)

### False Positives/Negatives

- Enable fingerprinting for better accuracy: `--fingerprint`
- Use SSH probe for Linux/Unix hosts
- Use TCP port probe for specific services
- Adjust timeout based on network latency

### Daemon Not Detecting Changes

- Check interval setting: `--interval 1m` for faster detection
- Verify notification configuration
- Review daemon logs for errors
- Ensure watched subnets are correct

## See Also

- [Inventory-less Execution](inventory-less-execution.md) - Running playbooks without inventory files
- [Inventory Guide](inventory.md) - Traditional inventory management
- [CLI Reference](cli.md) - Complete command-line options
